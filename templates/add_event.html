{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ - –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock %}

{% block content %}
<h1>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h1>

<form method="POST" action="{{ url_for('add_event') }}">
    <div class="form-group">
        <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è *</label>
        <input type="text" id="title" name="title" required 
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—Ç–æ–Ω –ß–µ—Ö–æ–≤ —Ä–æ–¥–∏–ª—Å—è –≤ 1860 –≥–æ–¥—É">
    </div>
    
    <div class="form-group">
        <label for="description">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="description" name="description" 
                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏"></textarea>
    </div>
    
    <div class="form-group">
        <label for="event_date">–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è *</label>
        <input type="date" id="event_date" name="event_date" required>
    </div>
    
    <div class="form-group">
        <label for="event_type">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</label>
        <select id="event_type" name="event_type" onchange="toggleReferenceFields()">
            <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</option>
            <option value="author">–°–≤—è–∑–∞–Ω–æ —Å –∞–≤—Ç–æ—Ä–æ–º</option>
            <option value="tag">–°–≤—è–∑–∞–Ω–æ —Å —Ç–µ–≥–æ–º</option>
            <option value="category">–°–≤—è–∑–∞–Ω–æ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π</option>
        </select>
    </div>
    
    <div class="form-group" id="reference_group" style="display: none;">
        <label for="reference_name">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞</label>
        <select id="reference_select" name="reference_select" onchange="updateReference()">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
        </select>
        <input type="hidden" id="reference_uuid" name="reference_uuid">
        <input type="hidden" id="reference_name" name="reference_name">
    </div>
    
    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
    <a href="{{ url_for('index') }}" class="btn">‚ùå –û—Ç–º–µ–Ω–∞</a>
</form>

<script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
    document.getElementById('event_type').addEventListener('change', function() {
        const eventType = this.value;
        const referenceGroup = document.getElementById('reference_group');
        const referenceSelect = document.getElementById('reference_select');
        
        if (eventType === 'custom') {
            referenceGroup.style.display = 'none';
            return;
        }
        
        referenceGroup.style.display = 'block';
        referenceSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API
        let apiUrl = '';
        if (eventType === 'author') {
            apiUrl = '/api/authors';
        } else if (eventType === 'tag') {
            apiUrl = '/api/tags';
        } else if (eventType === 'category') {
            apiUrl = '/api/categories';
        }
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                referenceSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
                const items = data[eventType + 's'] || [];
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.uuid;
                    option.textContent = item.name;
                    option.dataset.name = item.name;
                    referenceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                referenceSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            });
    });
    
    function updateReference() {
        const select = document.getElementById('reference_select');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            document.getElementById('reference_uuid').value = selectedOption.value;
            document.getElementById('reference_name').value = selectedOption.dataset.name || selectedOption.textContent;
        } else {
            document.getElementById('reference_uuid').value = '';
            document.getElementById('reference_name').value = '';
        }
    }
    
    function toggleReferenceFields() {
        const eventType = document.getElementById('event_type').value;
        const referenceGroup = document.getElementById('reference_group');
        
        if (eventType === 'custom') {
            referenceGroup.style.display = 'none';
        } else {
            referenceGroup.style.display = 'block';
            // –¢—Ä–∏–≥–≥–µ—Ä–∏–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
            document.getElementById('event_type').dispatchEvent(new Event('change'));
        }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('event_date').valueAsDate = new Date();
</script>
{% endblock %}

